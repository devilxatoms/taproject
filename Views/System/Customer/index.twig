{% block content %}
<div id="customer-index-module" v-cloak>
    <div class="header-buttons">
        <div class="btn-group main-buttons">
            <button
                class="btn btn-success"
                @click="newCustomer()">
                <span class="glyphicon glyphicon-plus"></span>
                Nuevo cliente
            </button>
        </div>
    </div>
    <div class="panel-content">
        <!--
            @export="exportTable"
            :select-options="selectOptions"
        -->
        
        <vue-dynamic-table-rbc
            box-classes="box box-primary full-height"
            class-name="table table-bordered table-hover"
            :remote-method="loadCustomers"
            :source-columns="columns"
            :data-model="listCustomers"
            {#@expand-row="expandCustomerContacts"#}
            :select-options="selectOptions"
            :total-results="totalResults"
            :pagination-options="{pageSizes: [20, 50, 100], pageSize: 100}"
            template-file-name="Listado de clientes">
            <template slot="businessLogo" scope="row">
                <div v-if ="(row.object.logo !== null)" class="text-center">
                    <img 
                        v-bind:src="'https://cdn.tuadmin.com/' + row.object.logo"
                        class="img-circle mw25 h20"
                        >
                </div>
            </template>
            <template slot="businessAddress" scope="row" >
                <div v-if="row.object.addresses">
                    <el-popover
                        ref="address"
                        placement="right"
                        width="200"
                        trigger="click">
                        <div>
                            <div class="borderBottom">
                                <h3 class="panel-title">Direccion Fiscal</h3>
                            </div>
                            <div>
                                ${row.object.addresses ?
                                ( (row.object.addresses.street ? row.object.addresses.street : ' ') +
                                (row.object.addresses.externalNumber ? (' #'+row.object.addresses.externalNumber) : 'SN')+ 
                                (row.object.addresses.internalNumber ? ('-'+row.object.addresses.internalNumber) : '') + 
                                (row.object.addresses.suburb ? (' Col. '+ row.object.addresses.suburb) : ' ') + ', ' + 
                                (row.object.addresses.municipality ? row.object.addresses.municipality : '') ) : 's/n'}
                            </div>
                            <div>
                                ${row.object.addresses ?
                                ( (row.object.addresses.state ? row.object.addresses.state : '') + ' ' +
                                (row.object.addresses.country ? row.object.addresses.country : '') + ' (' +
                                ((row.object.addresses.postalCode && row.object.addresses.postalCode != 0) 
                                ? row.object.addresses.postalCode : 'Sin Definir') + ')' ): 's/n'}
                            </div>
                            <div class="card-content" style="height: auto;">
                                ${row.object.addresses ? 
                                (row.object.addresses.reference ? 'Referencia: ' + row.object.addresses.reference : '')
                                :''}
                            </div>
                        </div>
                    </el-popover>
                    <el-tooltip 
                        class="item" 
                        effect="dark" 
                        content="Haz clic para ver detalles" 
                        placement="bottom-start">
                        <a
                            role="button"
                            v-popover:address 
                            class=" btn btn-info linkId">
                            <i class="fa fa-map-marker" aria-hidden="true"></i>
                            ${row.object.addresses ?  
                            ( (row.object.addresses.municipality ? row.object.addresses.municipality : '') + ', ' + 
                            (row.object.addresses.state ? row.object.addresses.state : '') + ', ' + 
                            (row.object.addresses.country ? row.object.addresses.country : '') + ' (' +
                            ((row.object.addresses.postalCode && row.object.addresses.postalCode != 0) 
                            ? row.object.addresses.postalCode : 'Sin Definir') + ')' ) : ''
                            }
                        </a>
                    </el-tooltip>
                </div>
            </template>
            <template slot="businessContact" scope="row" >
                <div v-if="row.object.contacts.length > 0">
                    <i class="fa fa-user"></i>
                    ${row.object.contacts[0].name}
                </div>
            </template>
    {#tabla de contactos#}
            <template slot="businessContactsList" scope="row">
                <h4 class="idp-title-subtitle" style="margin: 2px;">
                    <div class="btn-group main-buttons" >
                        <a
                            role="button"
                            class="btn btn "
                            data-action="openLateral"
                            href="?tabs=logistica/requisiciones/nuevo"
                            data-panelsize="lg">
                            <i class="fa fa-plus " aria-hidden="true"></i>
                            Nuevo contacto
                        </a>
                    </div>
                    Contactos | 
                    <span class="subtitle">${row.object.legalName}</span>
                </h4>
                <div 
                    class="box box-lg box-centered idp-dynamic-table" 
                    style=" max-width: 1300px; width: auto; height: 350px; z-index: 1;">
                    <vue-dynamic-table-rbc
                        box-classes="box box-primary full-height"
                        class-name="table table-bordered table-hover"
                        {#:remote-method="loadCustomerContacts"#}
                        :source-columns="columnsCustomerContacts"
                        :select-options="selectOptions"
                        :data-model="row.object.contacts"
                        {#:favorites="dynamicTableFavorites"#}
                        {#@save-to-favorites="saveToFavorites"
                        @loaded-favorite="loadedFavorite"#}
                        :total-results="row.object.contacts.length"
                        :pagination-options="{pageSizes: [10, 20, 50], pageSize: 10}"
                        hide-export
                        hide-import
                        {#hide-main-bar#}
                        template-file-name="customersContacts">
                       {% include 'System/Customer/contact/slot.twig'%}
                    </vue-dynamic-table-rbc>
                </div>
            </template>
    {#fin tabla de contactos#}
            <template slot="businessType" scope="row">
                ${ row.object.businessType }
            </template>
            <template slot="noSubsidiaries" scope="row">
                <a href="#" @click="showSubsidiaries">
                    <span class="glyphicon glyphicon-eye-close"></span>
                    ${ row.object.noSubsidiaries }
                </a>
            </template>
        </vue-dynamic-table-rbc>
    </div>

    <!-- -->
    <div 
        class="modal fade" 
        id="modal-subsidiaries" 
        tabindex="-1" role="dialog" 
        aria-labelledby="myModalLabel" 
        data-backdrop="false">
        <div class="modal-dialog modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Sucursales de cliente</h4>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Codigo de sucursal</th>
                                <th>Sucursal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="subsidiary in listCustomers">                                  
                                <td>${ subsidiary.code }</td>
                                <td>${ subsidiary.name }</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- -->
</div>
{% endblock %}

{% block loadScripts %}
<script id="scriptContainer" type="text/javascript">
    var args = [];

    args.push(
        {{ businessTypes | json_encode | raw }}
    );

    init = [
        {
            title: 'Listado de clientes',
            file: 'System/Customer/index.js',
            functions: [
                {
                    name: 'initModuleCustomerIndex',
                    args: args
                }
            ]
        }
    ];
</script>
{% endblock %}